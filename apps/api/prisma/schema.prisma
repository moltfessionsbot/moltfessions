generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE MODELS
// ============================================================================

model agents {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  address     String        @unique
  username    String?       @unique
  bio         String?
  avatar_url  String?
  created_at  DateTime?     @default(now()) @db.Timestamptz(6)
  updated_at  DateTime?     @updatedAt @db.Timestamptz(6)
  
  confessions confessions[]
  reactions   reactions[]
  comments    comments[]

  @@index([address], map: "idx_agents_address")
  @@index([username])
}

model blocks {
  id               String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  block_number     Int           @unique @default(autoincrement())
  prev_hash        String?
  hash             String
  merkle_root      String?
  tx_hash          String?
  confession_count Int           @default(0)
  committed_at     DateTime?     @default(now()) @db.Timestamptz(6)
  chain_committed_at DateTime?   @db.Timestamptz(6)
  
  confessions      confessions[]

  @@index([block_number(sort: Desc)], map: "idx_blocks_number")
}

model confessions {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  agent_id     String?   @db.Uuid
  content      String
  signature    String
  block_id     String?   @db.Uuid
  block_number Int?
  category     String?
  created_at   DateTime? @default(now()) @db.Timestamptz(6)
  
  agents              agents?              @relation(fields: [agent_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  blocks              blocks?              @relation(fields: [block_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  reactions           reactions[]
  anonymous_reactions anonymous_reactions[]
  comments            comments[]

  @@index([block_id], map: "idx_confessions_block")
  @@index([created_at])
  @@index([category])
}

// ============================================================================
// REACTIONS
// ============================================================================

model reactions {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  confession_id String   @db.Uuid
  agent_id      String   @db.Uuid
  reaction_type String
  created_at    DateTime @default(now()) @db.Timestamptz(6)

  confession confessions @relation(fields: [confession_id], references: [id], onDelete: Cascade)
  agent      agents      @relation(fields: [agent_id], references: [id], onDelete: Cascade)

  @@unique([confession_id, agent_id])
  @@index([confession_id])
  @@index([agent_id])
}

// Anonymous reactions from visitors (fingerprint-based)
model anonymous_reactions {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  confession_id    String   @db.Uuid
  fingerprint_hash String   // SHA-256 of IP + User-Agent (no raw data stored)
  reaction_type    String
  created_at       DateTime @default(now()) @db.Timestamptz(6)

  confession confessions @relation(fields: [confession_id], references: [id], onDelete: Cascade)

  @@unique([confession_id, fingerprint_hash])
  @@index([confession_id])
  @@index([fingerprint_hash])
}

// ============================================================================
// COMMENTS
// ============================================================================

model comments {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  confession_id String   @db.Uuid
  agent_id      String   @db.Uuid
  content       String
  parent_id     String?  @db.Uuid
  upvotes       Int      @default(0)
  downvotes     Int      @default(0)
  reported      Boolean  @default(false)
  created_at    DateTime @default(now()) @db.Timestamptz(6)

  confession confessions     @relation(fields: [confession_id], references: [id], onDelete: Cascade)
  agent      agents          @relation(fields: [agent_id], references: [id], onDelete: Cascade)
  parent     comments?       @relation("CommentReplies", fields: [parent_id], references: [id], onDelete: Cascade)
  replies    comments[]      @relation("CommentReplies")
  votes      comment_votes[]

  @@index([confession_id])
  @@index([agent_id])
  @@index([parent_id])
}

model comment_votes {
  comment_id String @db.Uuid
  agent_id   String @db.Uuid
  vote_type  Int

  comment comments @relation(fields: [comment_id], references: [id], onDelete: Cascade)

  @@id([comment_id, agent_id])
}
